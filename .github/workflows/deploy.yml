name: Deploy app to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'  # app í´ë” ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
      - '.github/workflows/deploy.yml'  # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ì‹œì—ë„ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ë°°í¬ í—ˆìš©

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app  # ëª¨ë“  run ëª…ë ¹ì€ app/ ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup SSH
        working-directory: .  # SSH ì„¤ì •ì€ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
        run: |
          # ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
          SSH_DIR="$HOME/.ssh"
          SSH_KEY="$SSH_DIR/deploy_key"

          # .ssh ë””ë ‰í† ë¦¬ ìƒì„± (ì´ë¯¸ íŒŒì¼ë¡œ ì¡´ì¬í•˜ë©´ ì œê±°)
          if [ -f "$SSH_DIR" ]; then
            rm -f "$SSH_DIR"
          fi
          mkdir -p "$SSH_DIR"
          chmod 700 "$SSH_DIR"

          # SSH í‚¤ íŒŒì¼ ìƒì„± (ê°œí–‰ ë¬¸ì ì²˜ë¦¬)
          # secretsì˜ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì €ì¥ (base64ë‚˜ ë‹¤ë¥¸ ì¸ì½”ë”©ì´ ì•„ë‹Œ ì›ë³¸)
          echo "${{ secrets.EC2_SSH_KEY }}" > "$SSH_KEY"
          chmod 600 "$SSH_KEY"

          # SSH í‚¤ íŒŒì¼ í˜•ì‹ í™•ì¸
          echo "ğŸ“‹ SSH í‚¤ íŒŒì¼ í™•ì¸:"
          if grep -q "BEGIN.*PRIVATE KEY" "$SSH_KEY"; then
            echo "âœ… SSH í‚¤ í˜•ì‹ í™•ì¸ë¨ (PRIVATE KEY)"
            # ì²« ì¤„ê³¼ ë§ˆì§€ë§‰ ì¤„ë§Œ í‘œì‹œ
            head -n 1 "$SSH_KEY"
            tail -n 1 "$SSH_KEY"
          else
            echo "âš ï¸ SSH í‚¤ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤"
            echo "ì²« 50ì: $(head -c 50 "$SSH_KEY")"
          fi

          # íŒŒì¼ í¬ê¸° í™•ì¸
          echo "ğŸ“ SSH í‚¤ íŒŒì¼ í¬ê¸°: $(wc -c < "$SSH_KEY") bytes"

          # known_hosts íŒŒì¼ ìƒì„± ë° EC2 í˜¸ìŠ¤íŠ¸ ì¶”ê°€
          touch "$SSH_DIR/known_hosts"
          chmod 600 "$SSH_DIR/known_hosts"
          ssh-keyscan -H "$EC2_HOST" >> "$SSH_DIR/known_hosts" 2>/dev/null || true

          # SSH config íŒŒì¼ ìƒì„±
          cat > "$SSH_DIR/config" << EOF
          Host ec2-deploy
            HostName $EC2_HOST
            User $EC2_USER
            IdentityFile $SSH_KEY
            StrictHostKeyChecking no
            UserKnownHostsFile $SSH_DIR/known_hosts
          EOF
          chmod 600 "$SSH_DIR/config"

          # SSH ì„¤ì • í™•ì¸
          echo "ğŸ“ SSH ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la "$SSH_DIR/"

          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸..."
          ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$EC2_USER@$EC2_HOST" "echo 'SSH ì—°ê²° ì„±ê³µ!'" || {
            echo "âš ï¸ SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          }

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt  # app/requirements.txt

      - name: Deploy to EC2
        working-directory: .  # rsyncëŠ” ë£¨íŠ¸ì—ì„œ app í´ë”ë¥¼ ëŒ€ìƒìœ¼ë¡œ
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
        run: |
          # ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
          SSH_KEY="$HOME/.ssh/deploy_key"

          # SSH í‚¤ íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [ ! -f "$SSH_KEY" ]; then
            echo "âŒ SSH í‚¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $SSH_KEY"
            exit 1
          fi

          # SSH í‚¤ ê¶Œí•œ í™•ì¸
          if [ "$(stat -c %a "$SSH_KEY" 2>/dev/null || stat -f %A "$SSH_KEY" 2>/dev/null)" != "600" ]; then
            echo "ğŸ”§ SSH í‚¤ ê¶Œí•œ ìˆ˜ì • ì¤‘..."
            chmod 600 "$SSH_KEY"
          fi

          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸..."
          ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            "$EC2_USER@$EC2_HOST" "echo 'SSH ì—°ê²° ì„±ê³µ!'" || {
            echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨"
            echo "ğŸ’¡ EC2_SSH_KEYì™€ EC2_HOST ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”"
            exit 1
          }

          # app í´ë”ë¥¼ EC2ì— ë™ê¸°í™” (SSH í‚¤ ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©)
          echo "ğŸ“¤ app í´ë” ë™ê¸°í™” ì¤‘..."
          rsync -avz -e "ssh -i $SSH_KEY -o StrictHostKeyChecking=no -o ConnectTimeout=10" \
            --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' \
            --exclude='venv' --exclude='.env' --exclude='*.pyc' \
            app/ "$EC2_USER@$EC2_HOST:/home/ubuntu/rag-app/"

          # EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
          ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$EC2_USER@$EC2_HOST" << 'ENDSSH'
            set -e

            echo "ğŸš€ ë°°í¬ ì‹œì‘..."

            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ubuntu/rag-app || {
              echo "âŒ ë°°í¬ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            }

            # Python ë° venv íŒ¨í‚¤ì§€ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ” Python í™˜ê²½ í™•ì¸ ì¤‘..."
            if ! command -v python3 &> /dev/null; then
              echo "âŒ Python3ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
              exit 1
            fi

            PYTHON_FULL_VERSION=$(python3 --version | cut -d' ' -f2)
            PYTHON_MAJOR_MINOR=$(echo "$PYTHON_FULL_VERSION" | cut -d'.' -f1,2)
            PYTHON_MAJOR=$(echo "$PYTHON_FULL_VERSION" | cut -d'.' -f1)
            PYTHON_MINOR=$(echo "$PYTHON_FULL_VERSION" | cut -d'.' -f2)

            echo "ğŸ“Œ Python ë²„ì „: $PYTHON_FULL_VERSION"
            echo "ğŸ“Œ Python ë²„ì „ (Major.Minor): $PYTHON_MAJOR_MINOR"

            # Python ë²„ì „ì— ë§ëŠ” venv íŒ¨í‚¤ì§€ ì„¤ì¹˜
            echo "ğŸ“¦ Python venv íŒ¨í‚¤ì§€ í™•ì¸ ë° ì„¤ì¹˜ ì¤‘..."
            sudo apt-get update -qq

            # Python ë²„ì „ë³„ venv íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„
            VENV_PACKAGE="python${PYTHON_MAJOR}.${PYTHON_MINOR}-venv"
            if apt-cache show "$VENV_PACKAGE" &>/dev/null; then
              echo "ğŸ“¦ $VENV_PACKAGE íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
              sudo apt-get install -y "$VENV_PACKAGE" python3-pip || {
                echo "âš ï¸ $VENV_PACKAGE ì„¤ì¹˜ ì‹¤íŒ¨, python3-venv ì‹œë„..."
                sudo apt-get install -y python3-venv python3-pip
              }
            else
              echo "ğŸ“¦ python3-venv íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
              sudo apt-get install -y python3-venv python3-pip
            fi

            # venv ëª¨ë“ˆ í™•ì¸
            if ! python3 -c "import venv" 2>/dev/null; then
              echo "âŒ venv ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "ğŸ’¡ ì„¤ì¹˜ëœ Python venv íŒ¨í‚¤ì§€ í™•ì¸ ì¤‘..."
              dpkg -l | grep -i python.*venv || echo "venv íŒ¨í‚¤ì§€ ì—†ìŒ"
              exit 1
            fi
            echo "âœ… venv ëª¨ë“ˆ í™•ì¸ë¨"

            # Python ê°€ìƒí™˜ê²½ ì„¤ì • (ë¶ˆì™„ì „í•œ venv ì²´í¬ ë° ì¬ìƒì„±)
            if [ -d "venv" ] && [ -f "venv/bin/activate" ] && [ -f "venv/bin/python3" ]; then
              echo "âœ… ê¸°ì¡´ ê°€ìƒí™˜ê²½ í™•ì¸ë¨"
            else
              if [ -d "venv" ]; then
                echo "âš ï¸ ë¶ˆì™„ì „í•œ ê°€ìƒí™˜ê²½ ê°ì§€, ì¬ìƒì„± ì¤‘..."
                rm -rf venv
              fi

              echo "ğŸ“¦ Python ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
              # venv ìƒì„± ì‹œë„
              if ! python3 -m venv venv 2>&1; then
                echo "âŒ ê°€ìƒí™˜ê²½ ìƒì„± ì‹¤íŒ¨"
                echo "ğŸ’¡ ensurepip í™•ì¸ ì¤‘..."
                python3 -c "import ensurepip; print('ensurepip ì‚¬ìš© ê°€ëŠ¥')" 2>&1 || {
                  echo "âš ï¸ ensurepip ì—†ìŒ, --without-pip ì˜µì…˜ìœ¼ë¡œ ìƒì„± ì‹œë„..."
                  python3 -m venv --without-pip venv
                  if [ -f "venv/bin/python3" ]; then
                    echo "ğŸ“¦ pip ì„¤ì¹˜ ì¤‘..."
                    venv/bin/python3 -m ensurepip --upgrade || {
                      curl -sS https://bootstrap.pypa.io/get-pip.py | venv/bin/python3
                    }
                  fi
                }
              fi

              # venv ìƒì„± í™•ì¸
              if [ ! -f "venv/bin/activate" ] || [ ! -f "venv/bin/python3" ]; then
                echo "âŒ ê°€ìƒí™˜ê²½ ìƒì„± ì‹¤íŒ¨"
                echo "ğŸ’¡ ë””ë²„ê¹… ì •ë³´:"
                ls -la venv/ 2>/dev/null || echo "venv ë””ë ‰í† ë¦¬ ì—†ìŒ"
                ls -la venv/bin/ 2>/dev/null || echo "venv/bin ë””ë ‰í† ë¦¬ ì—†ìŒ"
                exit 1
              fi
              echo "âœ… ê°€ìƒí™˜ê²½ ìƒì„± ì™„ë£Œ"
            fi

            # ê°€ìƒí™˜ê²½ í™œì„±í™”
            echo "ğŸ”„ ê°€ìƒí™˜ê²½ í™œì„±í™” ì¤‘..."
            source venv/bin/activate

            # ê°€ìƒí™˜ê²½ í™œì„±í™” í™•ì¸
            if [ -z "$VIRTUAL_ENV" ]; then
              echo "âŒ ê°€ìƒí™˜ê²½ í™œì„±í™” ì‹¤íŒ¨"
              echo "ğŸ’¡ ë””ë²„ê¹… ì •ë³´:"
              echo "   - venv ë””ë ‰í† ë¦¬ ì¡´ì¬: $([ -d "venv" ] && echo "ì˜ˆ" || echo "ì•„ë‹ˆì˜¤")"
              echo "   - activate ìŠ¤í¬ë¦½íŠ¸ ì¡´ì¬: $([ -f "venv/bin/activate" ] && echo "ì˜ˆ" || echo "ì•„ë‹ˆì˜¤")"
              ls -la venv/bin/activate 2>/dev/null || echo "   - activate íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
              exit 1
            fi
            echo "âœ… ê°€ìƒí™˜ê²½ í™œì„±í™”ë¨: $VIRTUAL_ENV"
            echo "ğŸ“Œ Python ê²½ë¡œ: $(which python)"
            echo "ğŸ“Œ pip ê²½ë¡œ: $(which pip)"

            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ ë° ì •ë¦¬
            echo "ğŸ’¾ ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ ì¤‘..."
            df -h /

            # í•­ìƒ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰ (ë””ìŠ¤í¬ ê³µê°„ í™•ë³´)
            echo "ğŸ§¹ ë””ìŠ¤í¬ ì •ë¦¬ ì¤‘..."
            # pip ìºì‹œ ì •ë¦¬
            pip cache purge 2>/dev/null || true
            # apt ìºì‹œ ì •ë¦¬
            sudo apt-get clean 2>/dev/null || true
            sudo apt-get autoremove -y 2>/dev/null || true
            # ì„ì‹œ íŒŒì¼ ì •ë¦¬
            sudo rm -rf /tmp/* 2>/dev/null || true
            sudo rm -rf /var/tmp/* 2>/dev/null || true
            # ë¡œê·¸ íŒŒì¼ ì •ë¦¬ (ì˜¤ë˜ëœ ê²ƒë§Œ)
            sudo journalctl --vacuum-time=1d 2>/dev/null || true

            echo "âœ… ì •ë¦¬ ì™„ë£Œ"
            df -h /

            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            pip install --upgrade pip

            # CPU ì „ìš© torch ë¨¼ì € ì„¤ì¹˜ (CUDA ì—†ìŒ, ìš©ëŸ‰ ì ˆì•½)
            echo "ğŸ“¦ CPU ì „ìš© PyTorch ì„¤ì¹˜ ì¤‘..."
            pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu || {
              echo "âš ï¸ CPU ì „ìš© torch ì„¤ì¹˜ ì‹¤íŒ¨"
              exit 1
            }
            echo "âœ… PyTorch CPU ë²„ì „ ì„¤ì¹˜ ì™„ë£Œ"

            # ë‚˜ë¨¸ì§€ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ìºì‹œ ì—†ì´)
            echo "ğŸ“¦ ë‚˜ë¨¸ì§€ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
            pip install --no-cache-dir -r requirements.txt

            # EC2 ë‚´ë¶€ ë°©í™”ë²½ í™•ì¸ ë° ë¹„í™œì„±í™”
            echo "ğŸ”¥ ë°©í™”ë²½ ìƒíƒœ í™•ì¸ ì¤‘..."
            if command -v ufw &> /dev/null; then
              if sudo ufw status | grep -q "Status: active"; then
                echo "âš ï¸ ufwê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í¬íŠ¸ 8000 í—ˆìš© ì¤‘..."
                sudo ufw allow 8000/tcp
                sudo ufw reload
              else
                echo "âœ… ufw ë¹„í™œì„±í™”ë¨"
              fi
            fi

            # systemd ì„œë¹„ìŠ¤ í™•ì¸ ë° ì„¤ì •
            echo "ğŸ” systemd ì„œë¹„ìŠ¤ í™•ì¸ ì¤‘..."
            if [ ! -f /etc/systemd/system/fastapi-rag.service ]; then
              echo "ğŸ“ systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì¤‘..."
              cat << 'EOFSERVICE' | sudo tee /etc/systemd/system/fastapi-rag.service > /dev/null
[Unit]
Description=FastAPI RAG Backend
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/home/ubuntu/rag-app
Environment="PATH=/home/ubuntu/rag-app/venv/bin"
Environment="PYTHONPATH=/home/ubuntu/rag-app"
EnvironmentFile=/home/ubuntu/rag-app/.env
ExecStart=/home/ubuntu/rag-app/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOFSERVICE
              sudo systemctl daemon-reload
              sudo systemctl enable fastapi-rag
            fi

            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            echo "ğŸ”„ FastAPI ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
            sudo systemctl restart fastapi-rag
            sleep 3

            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
            sudo systemctl status fastapi-rag --no-pager -l || true

            # í¬íŠ¸ ë¦¬ìŠ¤ë‹ í™•ì¸
            echo "ğŸ” í¬íŠ¸ 8000 ë¦¬ìŠ¤ë‹ í™•ì¸ ì¤‘..."
            if sudo netstat -tuln | grep -q ":8000 " || sudo ss -tuln | grep -q ":8000 "; then
              echo "âœ… í¬íŠ¸ 8000ì´ ë¦¬ìŠ¤ë‹ ì¤‘ì…ë‹ˆë‹¤"
              sudo netstat -tuln | grep ":8000 " || sudo ss -tuln | grep ":8000 "
            else
              echo "âŒ í¬íŠ¸ 8000ì´ ë¦¬ìŠ¤ë‹ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
              echo "ğŸ’¡ ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸:"
              sudo journalctl -u fastapi-rag -n 50 --no-pager || true
            fi

            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            sleep 5
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
            else
              echo "âš ï¸ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              echo "ğŸ’¡ ì„œë¹„ìŠ¤ ë¡œê·¸:"
              sudo journalctl -u fastapi-rag -n 30 --no-pager || true
              echo "ğŸ’¡ ìˆ˜ë™ ì‹¤í–‰ í…ŒìŠ¤íŠ¸:"
              echo "   cd /home/ubuntu/rag-app"
              echo "   source venv/bin/activate"
              echo "   uvicorn main:app --host 0.0.0.0 --port 8000"
            fi

            # ì™¸ë¶€ ì ‘ì† ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ (EC2 ë‚´ë¶€ì—ì„œ)
            echo "ğŸŒ ì™¸ë¶€ ì ‘ì† í…ŒìŠ¤íŠ¸..."
            PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "í™•ì¸ ë¶ˆê°€")
            echo "ğŸ“Œ Public IP: $PUBLIC_IP"
            if [ "$PUBLIC_IP" != "í™•ì¸ ë¶ˆê°€" ]; then
              echo "ğŸ’¡ ì™¸ë¶€ì—ì„œ ì ‘ì†: http://$PUBLIC_IP:8000/docs"
            fi

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          ENDSSH

      - name: Deployment Status
        run: |
          echo "âœ… ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"
          echo "ë°±ì—”ë“œ: http://${{ secrets.EC2_HOST }}:8000"
          echo "API ë¬¸ì„œ: http://${{ secrets.EC2_HOST }}:8000/docs"
