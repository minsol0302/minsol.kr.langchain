name: Deploy app to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'  # app í´ë” ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
      - '.github/workflows/deploy.yml'  # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ì‹œì—ë„ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ë°°í¬ í—ˆìš©

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app  # ëª¨ë“  run ëª…ë ¹ì€ app/ ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup SSH
        working-directory: .  # SSH ì„¤ì •ì€ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
        run: |
          # ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
          SSH_DIR="$HOME/.ssh"
          SSH_KEY="$SSH_DIR/deploy_key"

          # .ssh ë””ë ‰í† ë¦¬ ìƒì„± (ì´ë¯¸ íŒŒì¼ë¡œ ì¡´ì¬í•˜ë©´ ì œê±°)
          if [ -f "$SSH_DIR" ]; then
            rm -f "$SSH_DIR"
          fi
          mkdir -p "$SSH_DIR"
          chmod 700 "$SSH_DIR"

          # SSH í‚¤ íŒŒì¼ ìƒì„± (ê°œí–‰ ë¬¸ì ì²˜ë¦¬)
          # secretsì˜ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì €ì¥ (base64ë‚˜ ë‹¤ë¥¸ ì¸ì½”ë”©ì´ ì•„ë‹Œ ì›ë³¸)
          echo "${{ secrets.EC2_SSH_KEY }}" > "$SSH_KEY"
          chmod 600 "$SSH_KEY"

          # SSH í‚¤ íŒŒì¼ í˜•ì‹ í™•ì¸
          echo "ğŸ“‹ SSH í‚¤ íŒŒì¼ í™•ì¸:"
          if grep -q "BEGIN.*PRIVATE KEY" "$SSH_KEY"; then
            echo "âœ… SSH í‚¤ í˜•ì‹ í™•ì¸ë¨ (PRIVATE KEY)"
            # ì²« ì¤„ê³¼ ë§ˆì§€ë§‰ ì¤„ë§Œ í‘œì‹œ
            head -n 1 "$SSH_KEY"
            tail -n 1 "$SSH_KEY"
          else
            echo "âš ï¸ SSH í‚¤ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤"
            echo "ì²« 50ì: $(head -c 50 "$SSH_KEY")"
          fi

          # íŒŒì¼ í¬ê¸° í™•ì¸
          echo "ğŸ“ SSH í‚¤ íŒŒì¼ í¬ê¸°: $(wc -c < "$SSH_KEY") bytes"

          # known_hosts íŒŒì¼ ìƒì„± ë° EC2 í˜¸ìŠ¤íŠ¸ ì¶”ê°€
          touch "$SSH_DIR/known_hosts"
          chmod 600 "$SSH_DIR/known_hosts"
          ssh-keyscan -H "$EC2_HOST" >> "$SSH_DIR/known_hosts" 2>/dev/null || true

          # SSH config íŒŒì¼ ìƒì„±
          cat > "$SSH_DIR/config" << EOF
          Host ec2-deploy
            HostName $EC2_HOST
            User $EC2_USER
            IdentityFile $SSH_KEY
            StrictHostKeyChecking no
            UserKnownHostsFile $SSH_DIR/known_hosts
          EOF
          chmod 600 "$SSH_DIR/config"

          # SSH ì„¤ì • í™•ì¸
          echo "ğŸ“ SSH ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la "$SSH_DIR/"

          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸..."
          ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$EC2_USER@$EC2_HOST" "echo 'SSH ì—°ê²° ì„±ê³µ!'" || {
            echo "âš ï¸ SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
          }

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt  # app/requirements.txt

      - name: Deploy to EC2
        working-directory: .  # rsyncëŠ” ë£¨íŠ¸ì—ì„œ app í´ë”ë¥¼ ëŒ€ìƒìœ¼ë¡œ
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
        run: |
          # ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
          SSH_KEY="$HOME/.ssh/deploy_key"

          # SSH í‚¤ íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [ ! -f "$SSH_KEY" ]; then
            echo "âŒ SSH í‚¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $SSH_KEY"
            exit 1
          fi

          # SSH í‚¤ ê¶Œí•œ í™•ì¸
          if [ "$(stat -c %a "$SSH_KEY" 2>/dev/null || stat -f %A "$SSH_KEY" 2>/dev/null)" != "600" ]; then
            echo "ğŸ”§ SSH í‚¤ ê¶Œí•œ ìˆ˜ì • ì¤‘..."
            chmod 600 "$SSH_KEY"
          fi

          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸..."
          ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            "$EC2_USER@$EC2_HOST" "echo 'SSH ì—°ê²° ì„±ê³µ!'" || {
            echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨"
            echo "ğŸ’¡ EC2_SSH_KEYì™€ EC2_HOST ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”"
            exit 1
          }

          # app í´ë”ë¥¼ EC2ì— ë™ê¸°í™” (SSH í‚¤ ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©)
          echo "ğŸ“¤ app í´ë” ë™ê¸°í™” ì¤‘..."
          rsync -avz -e "ssh -i $SSH_KEY -o StrictHostKeyChecking=no -o ConnectTimeout=10" \
            --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' \
            --exclude='venv' --exclude='.env' --exclude='*.pyc' \
            app/ "$EC2_USER@$EC2_HOST:/home/ubuntu/rag-app/"

          # EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
          ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$EC2_USER@$EC2_HOST" << 'ENDSSH'
            set -e

            echo "ğŸš€ ë°°í¬ ì‹œì‘..."

            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ubuntu/rag-app || {
              echo "âŒ ë°°í¬ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            }

            # Python ë° venv íŒ¨í‚¤ì§€ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ” Python í™˜ê²½ í™•ì¸ ì¤‘..."
            if ! command -v python3 &> /dev/null; then
              echo "âŒ Python3ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
              exit 1
            fi

            PYTHON_VERSION=$(python3 --version | cut -d' ' -f2 | cut -d'.' -f1,2)
            echo "ğŸ“Œ Python ë²„ì „: $(python3 --version)"

            # python3-venv íŒ¨í‚¤ì§€ í™•ì¸ ë° ì„¤ì¹˜
            if ! python3 -m venv --help &> /dev/null; then
              echo "ğŸ“¦ python3-venv íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
              sudo apt-get update -qq
              sudo apt-get install -y python3-venv python3-pip
            fi

            # Python ê°€ìƒí™˜ê²½ ì„¤ì •
            if [ -d "venv" ]; then
              echo "âœ… ê¸°ì¡´ ê°€ìƒí™˜ê²½ ì‚¬ìš©"
              source venv/bin/activate
            else
              echo "ğŸ“¦ Python ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
              python3 -m venv venv
              source venv/bin/activate
            fi

            # ê°€ìƒí™˜ê²½ í™œì„±í™” í™•ì¸
            if [ -z "$VIRTUAL_ENV" ]; then
              echo "âŒ ê°€ìƒí™˜ê²½ í™œì„±í™” ì‹¤íŒ¨"
              exit 1
            fi
            echo "âœ… ê°€ìƒí™˜ê²½ í™œì„±í™”ë¨: $VIRTUAL_ENV"

            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            pip install --upgrade pip
            pip install -r requirements.txt

            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            if systemctl is-active --quiet fastapi-rag 2>/dev/null; then
              echo "ğŸ”„ FastAPI ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
              sudo systemctl restart fastapi-rag
            else
              echo "âš ï¸ fastapi-rag ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
              echo "ğŸ’¡ systemd ì„œë¹„ìŠ¤ë¥¼ ì„¤ì •í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”."
            fi

            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            sleep 5
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
            else
              echo "âš ï¸ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            fi

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          ENDSSH

      - name: Deployment Status
        run: |
          echo "âœ… ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"
          echo "ë°±ì—”ë“œ: http://${{ secrets.EC2_HOST }}:8000"
          echo "API ë¬¸ì„œ: http://${{ secrets.EC2_HOST }}:8000/docs"
