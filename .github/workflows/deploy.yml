name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ë°°í¬ í—ˆìš©

jobs:
  deploy:
    name: Deploy Backend and Frontend to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          # .ssh ë””ë ‰í† ë¦¬ ìƒì„± (ì´ë¯¸ íŒŒì¼ë¡œ ì¡´ì¬í•˜ë©´ ì œê±°)
          if [ -f ~/.ssh ]; then
            rm -f ~/.ssh
          fi
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # SSH í‚¤ íŒŒì¼ ìƒì„±
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # known_hosts íŒŒì¼ ìƒì„± ë° EC2 í˜¸ìŠ¤íŠ¸ ì¶”ê°€
          touch ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

          # SSH ì„¤ì • í™•ì¸
          ls -la ~/.ssh/

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            set -e

            echo "ğŸš€ ë°°í¬ ì‹œì‘..."

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/my_project/RAG || {
              echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "ğŸ’¡ ì´ˆê¸° ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. scripts/setup-ec2.shë¥¼ ì‹¤í–‰í•˜ì„¸ìš”."
              exit 1
            }

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            if [ -f "scripts/deploy.sh" ]; then
              echo "ğŸ“œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰..."
              chmod +x scripts/deploy.sh
              bash scripts/deploy.sh
            else
              echo "âš ï¸ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ ë°°í¬ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."

              # Git Pull
              echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
              git fetch origin
              git reset --hard origin/main
              git clean -fd

              # ë°±ì—”ë“œ ë°°í¬
              echo "ğŸ”§ ë°±ì—”ë“œ ë°°í¬ ì¤‘..."
              if [ -d "venv" ]; then
                source venv/bin/activate
              else
                python3 -m venv venv
                source venv/bin/activate
              fi

              pip install --upgrade pip
              pip install -r app/requirements.txt

              # ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
              if systemctl is-active --quiet fastapi-rag 2>/dev/null; then
                sudo systemctl restart fastapi-rag
              else
                echo "âš ï¸ fastapi-rag ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
              fi

              # í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
              echo "ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì¤‘..."
              cd frontend
              npm ci
              npm run build

              if systemctl is-active --quiet nextjs-frontend 2>/dev/null; then
                sudo systemctl restart nextjs-frontend
              else
                echo "âš ï¸ nextjs-frontend ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
              fi

              cd ..
            fi

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          ENDSSH

      - name: Deployment Status
        run: |
          echo "âœ… ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"
          echo "ë°±ì—”ë“œ: http://${{ secrets.EC2_HOST }}:8000"
          echo "í”„ë¡ íŠ¸ì—”ë“œ: http://${{ secrets.EC2_HOST }}:3000"
