name: Deploy app to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'  # app í´ë” ë³€ê²½ì‹œì—ë§Œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ë°°í¬ í—ˆìš©

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: app  # ëª¨ë“  run ëª…ë ¹ì€ app/ ë””ë ‰í† ë¦¬ì—ì„œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup SSH
        working-directory: .  # SSH ì„¤ì •ì€ ë£¨íŠ¸ì—ì„œ ì‹¤í–‰
        run: |
          # .ssh ë””ë ‰í† ë¦¬ ìƒì„± (ì´ë¯¸ íŒŒì¼ë¡œ ì¡´ì¬í•˜ë©´ ì œê±°)
          if [ -f ~/.ssh ]; then
            rm -f ~/.ssh
          fi
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # SSH í‚¤ íŒŒì¼ ìƒì„±
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # known_hosts íŒŒì¼ ìƒì„± ë° EC2 í˜¸ìŠ¤íŠ¸ ì¶”ê°€
          touch ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

          # SSH ì„¤ì • í™•ì¸
          ls -la ~/.ssh/

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt  # app/requirements.txt

      - name: Deploy to EC2
        working-directory: .  # rsyncëŠ” ë£¨íŠ¸ì—ì„œ app í´ë”ë¥¼ ëŒ€ìƒìœ¼ë¡œ
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ubuntu' }}
        run: |
          # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} "echo 'SSH ì—°ê²° ì„±ê³µ!'" || {
            echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨"
            exit 1
          }

          # app í´ë”ë¥¼ EC2ì— ë™ê¸°í™” (SSH í‚¤ ëª…ì‹œ)
          echo "ğŸ“¤ app í´ë” ë™ê¸°í™” ì¤‘..."
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' \
            --exclude='venv' --exclude='.env' \
            app/ ${EC2_USER}@${EC2_HOST}:/home/ubuntu/rag-app/

          # EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'ENDSSH'
            set -e

            echo "ğŸš€ ë°°í¬ ì‹œì‘..."

            # ë°°í¬ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ubuntu/rag-app || {
              echo "âŒ ë°°í¬ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            }

            # Python ê°€ìƒí™˜ê²½ ì„¤ì •
            if [ -d "venv" ]; then
              source venv/bin/activate
            else
              echo "ğŸ“¦ Python ê°€ìƒí™˜ê²½ ìƒì„± ì¤‘..."
              python3 -m venv venv
              source venv/bin/activate
            fi

            # ì˜ì¡´ì„± ì„¤ì¹˜
            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
            pip install --upgrade pip
            pip install -r requirements.txt

            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            if systemctl is-active --quiet fastapi-rag 2>/dev/null; then
              echo "ğŸ”„ FastAPI ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
              sudo systemctl restart fastapi-rag
            else
              echo "âš ï¸ fastapi-rag ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
              echo "ğŸ’¡ systemd ì„œë¹„ìŠ¤ë¥¼ ì„¤ì •í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”."
            fi

            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            sleep 5
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
            else
              echo "âš ï¸ ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            fi

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          ENDSSH

      - name: Deployment Status
        run: |
          echo "âœ… ë°°í¬ í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"
          echo "ë°±ì—”ë“œ: http://${{ secrets.EC2_HOST }}:8000"
          echo "API ë¬¸ì„œ: http://${{ secrets.EC2_HOST }}:8000/docs"
